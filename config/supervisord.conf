# Agentbox Minimal Supervisord Configuration
# ARM64 + x86_64 compatible, headless deployment

[supervisord]
nodaemon=true
logfile=/var/log/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
user=root

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0766

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# ============================================================================
# SSH Server (Port 22)
# ============================================================================

[program:sshd]
command=/usr/sbin/sshd -D -e
user=root
autostart=true
autorestart=true
priority=50
stdout_logfile=/var/log/sshd.log
stderr_logfile=/var/log/sshd.error.log

# ============================================================================
# Management API (Port 9090)
# ============================================================================

[program:management-api]
command=/usr/local/bin/node /opt/management-api/server.js
directory=/opt/management-api
user=devuser
environment=HOME="/home/devuser",PORT="9090",NODE_ENV="production"
autostart=true
autorestart=true
priority=100
stdout_logfile=/var/log/management-api.log
stderr_logfile=/var/log/management-api.error.log

# ============================================================================
# Claude Z.AI Service (Port 9600 - Internal Only)
# Cost-effective Claude API proxy
# ============================================================================

[program:claude-zai]
command=/usr/local/bin/node /opt/claude-zai/server.js
directory=/opt/claude-zai
user=zai-user
environment=HOME="/home/zai-user",PORT="9600",NODE_ENV="production"
autostart=true
autorestart=true
priority=200
stdout_logfile=/var/log/claude-zai.log
stderr_logfile=/var/log/claude-zai.error.log

# ============================================================================
# MCP Gateway (TCP + WebSocket)
# Claude Flow V3 MCP Infrastructure
# ============================================================================

[program:mcp-gateway]
command=/usr/local/bin/node /opt/mcp/servers/mcp-gateway.js
directory=/opt/mcp/servers
user=devuser
environment=HOME="/home/devuser",MCP_TCP_PORT="9500",MCP_WS_PORT="3002",LOG_LEVEL="info"
autostart=true
autorestart=true
priority=150
stdout_logfile=/var/log/mcp-gateway.log
stderr_logfile=/var/log/mcp-gateway.error.log

# ============================================================================
# code-server (Port 8080) - Optional web IDE
# Start manually: supervisorctl start code-server
# ============================================================================

[program:code-server]
command=/usr/bin/code-server --bind-addr 0.0.0.0:8080 --auth none /workspace
user=devuser
environment=HOME="/home/devuser",USER="devuser"
autostart=false
autorestart=true
priority=300
stdout_logfile=/var/log/code-server.log
stderr_logfile=/var/log/code-server.error.log

# ============================================================================
# Optional MCP Servers (on-demand)
# Start with: supervisorctl start <service>
# ============================================================================

[program:web-summary-mcp]
command=/usr/local/bin/node /opt/skills/web-summary/mcp-server/server.js
directory=/opt/skills/web-summary/mcp-server
user=devuser
environment=HOME="/home/devuser",ZAI_CONTAINER_URL="http://localhost:9600"
autostart=false
autorestart=true
priority=400
stdout_logfile=/var/log/web-summary-mcp.log
stderr_logfile=/var/log/web-summary-mcp.error.log

[program:imagemagick-mcp]
command=/usr/bin/python3 -u /opt/skills/imagemagick/tools/imagemagick_mcp.py
directory=/opt/skills/imagemagick/tools
user=devuser
environment=HOME="/home/devuser"
autostart=false
autorestart=true
priority=401
stdout_logfile=/var/log/imagemagick-mcp.log
stderr_logfile=/var/log/imagemagick-mcp.error.log

[program:playwright-mcp]
command=/usr/local/bin/node /opt/skills/playwright/tools/playwright_mcp.js
directory=/opt/skills/playwright/tools
user=devuser
environment=HOME="/home/devuser",PLAYWRIGHT_BROWSERS_PATH="/opt/playwright-browsers"
autostart=false
autorestart=true
priority=402
stdout_logfile=/var/log/playwright-mcp.log
stderr_logfile=/var/log/playwright-mcp.error.log

# ============================================================================
# VNC Remote Desktop via SSH Tunnel (Optional - Desktop Image Only)
# Start: supervisorctl start xvfb x11vnc openbox
# Access: ssh -L 5901:localhost:5901 user@host, then vnc://localhost:5901
# ============================================================================

[program:xvfb]
command=/usr/bin/Xvfb :1 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset
user=root
environment=HOME="/root"
autostart=false
autorestart=true
priority=80
stdout_logfile=/var/log/xvfb.log
stderr_logfile=/var/log/xvfb.error.log
stopasgroup=true
killasgroup=true

[program:x11vnc]
# Binds to localhost only - access via SSH tunnel for security
# No password by default - SSH provides authentication
command=/usr/bin/x11vnc -display :1 -rfbport 5901 -localhost -forever -shared -nopw -xkb -cursor arrow -repeat -nowcr
user=root
environment=HOME="/root",DISPLAY=":1"
autostart=false
autorestart=true
priority=85
stdout_logfile=/var/log/x11vnc.log
stderr_logfile=/var/log/x11vnc.error.log
depends_on=xvfb
stopasgroup=true
killasgroup=true

[program:openbox]
# Minimal window manager - lightweight alternative to full DE
command=/usr/bin/openbox
user=devuser
environment=HOME="/home/devuser",USER="devuser",DISPLAY=":1"
autostart=false
autorestart=true
priority=90
stdout_logfile=/var/log/openbox.log
stderr_logfile=/var/log/openbox.error.log
depends_on=xvfb
startsecs=3
stopasgroup=true
killasgroup=true

# ============================================================================
# VNC Group - Start all VNC services at once
# Usage: supervisorctl start vnc:*
# ============================================================================

[group:vnc]
programs=xvfb,x11vnc,openbox
priority=80
